name: Enrich EPG XML with TVmaze Episode Info

on:
  schedule:
    - cron: '10 0 * * *'  # Daily at 00:10 UTC
  workflow_dispatch:

jobs:
  enrich_epgs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install lxml requests fuzzywuzzy[speedup]

      - name: Enrich XML files using TVmaze + fuzzy description matching
        run: |
          python3 - <<'EOF'
          import time
          import glob
          import re
          import requests
          from lxml import etree
          from fuzzywuzzy import fuzz

          def normalize(text):
              return re.sub(r'\W+', ' ', text or '').strip().lower()

          def fetch_show_episodes(title, cache):
              if title in cache:
                  return cache[title]
              try:
                  res = requests.get(f"https://api.tvmaze.com/singlesearch/shows?q={title}&embed=episodes", timeout=10)
                  if res.status_code == 200:
                      data = res.json()
                      episodes = data["_embedded"]["episodes"]
                      cache[title] = episodes
                      time.sleep(0.5)  # polite throttle
                      return episodes
              except Exception as e:
                  print(f"TVmaze fetch failed for '{title}': {e}")
              cache[title] = []
              return []

          def find_best_match(title, desc, episodes):
              input_text = normalize(f"{title} {desc}")
              best_score = 0
              best_ep = None
              for ep in episodes:
                  overview = ep.get("summary") or ""
                  compare_text = normalize(f"{title} {overview}")
                  score = fuzz.partial_ratio(input_text, compare_text)
                  if score > best_score:
                      best_score = score
                      best_ep = ep
              if best_score >= 65:
                  return best_ep
              elif best_score > 0:
                  print(f"‚Ü™ Closest match score for '{title}': {best_score} ‚Äî '{best_ep['name']}'")
              return None

          cache = {}

          for xml_file in glob.glob("individual/*.xml"):
              print(f"üìÇ Processing {xml_file}")
              parser = etree.XMLParser(recover=True)
              tree = etree.parse(xml_file, parser)
              root = tree.getroot()

              for prog in root.findall("programme"):
                  title_el = prog.find("title")
                  desc_el = prog.find("desc")
                  if title_el is None or desc_el is None:
                      continue

                  title = title_el.text.strip()
                  desc = desc_el.text.strip()

                  episodes = fetch_show_episodes(title, cache)
                  if not episodes:
                      print(f"‚ùå No episodes found for show: {title}")
                      continue

                  best_ep = find_best_match(title, desc, episodes)
                  if best_ep:
                      season = best_ep["season"]
                      episode = best_ep["number"]
                      ep_title = best_ep["name"] or ""

                      # Add or update episode-num
                      ep_num_el = prog.find("episode-num[@system='xmltv_ns']")
                      if ep_num_el is None:
                          ep_num_el = etree.SubElement(prog, "episode-num", system="xmltv_ns")
                      ep_num_el.text = f"{season - 1}.{episode}.0"

                      # Add or update sub-title
                      sub_title_el = prog.find("sub-title")
                      if sub_title_el is None:
                          sub_title_el = etree.Element("sub-title", lang="en")
                          title_index = list(prog).index(title_el)
                          prog.insert(title_index + 1, sub_title_el)
                      sub_title_el.text = ep_title

                      # Add or update original air date <date>
                      if best_ep.get("airdate"):
                          date_str = best_ep["airdate"].replace("-", "")  # YYYYMMDD format
                          airdate_el = prog.find("date")
                          if airdate_el is not None:
                              airdate_el.text = date_str
                          else:
                              desc_el_index = list(prog).index(desc_el)
                              new_date_el = etree.Element("date")
                              new_date_el.text = date_str
                              prog.insert(desc_el_index + 1, new_date_el)

                      print(f"‚úî Matched {title}: S{season:02}E{episode:02} ‚Äî '{ep_title}'")
                  else:
                      print(f"‚ö†Ô∏è No good match found for {title}: \"{desc[:80]}...\"")

              tree.write(xml_file, encoding="utf-8", xml_declaration=True)
          EOF

      - name: Commit & push if changed
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add individual/*.xml
          git diff --cached --quiet || (git commit -m "Enriched EPG XML with TVmaze episode data + original airdate" && git push)
